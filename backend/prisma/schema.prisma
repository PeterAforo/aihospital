generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MULTI-TENANCY ====================

enum TenantType {
  HOSPITAL
  CLINIC
  DIAGNOSTIC_CENTER
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  EXPIRED
}

model Tenant {
  id               String           @id @default(uuid())
  name             String
  subdomain        String           @unique
  slug             String?          @unique
  type             TenantType       @default(HOSPITAL)
  subscriptionPlan SubscriptionPlan @default(STARTER)
  tenantStatus     TenantStatus     @default(ACTIVE)
  maxUsers         Int              @default(10)
  maxBranches      Int              @default(5)
  logo             String?
  phone            String
  email            String
  address          String?
  city             String?
  region           String?
  licenseNumber    String?
  settings         Json?
  isActive         Boolean          @default(true)
  expiresAt        DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Data sharing settings for multi-branch
  sharedEmr       Boolean @default(true)
  sharedBilling   Boolean @default(true)
  sharedInventory Boolean @default(false)
  sharedLab       Boolean @default(true)

  branches        Branch[]
  users           User[]
  patients        Patient[]
  employees       Employee[]
  roles           Role[]
  departments     Department[]
  auditLogs       AuditLog[]
  serviceCatalog        ServiceCatalog[]
  discountSchemes       DiscountScheme[]
  categoryProfitSettings CategoryProfitSettings[]

  @@map("tenants")
}

enum BranchType {
  MAIN
  SATELLITE_CLINIC
  DIAGNOSTIC_CENTER
  MATERNITY_WARD
  PHARMACY
  LAB
}

model Branch {
  id             String     @id @default(uuid())
  tenantId       String
  name           String
  code           String?
  branchType     BranchType @default(MAIN)
  parentBranchId String?
  phone          String
  email          String
  address        String
  city           String?
  region         String?
  gpsCoordinates Json?
  isActive       Boolean    @default(true)
  isMainBranch   Boolean    @default(false)
  operatingHours Json?
  hasEmergency   Boolean    @default(false)
  hasInpatient   Boolean    @default(false)
  hasLab         Boolean    @default(true)
  hasPharmacy    Boolean    @default(true)
  settings       Json?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentBranch         Branch?            @relation("BranchHierarchy", fields: [parentBranchId], references: [id])
  childBranches        Branch[]           @relation("BranchHierarchy")
  appointments         Appointment[]
  encounters           Encounter[]
  users                User[]
  branchPermissions    BranchPermission[]
  patientsRegisteredAt Patient[]          @relation("PatientRegisteredBranch")
  auditLogs            AuditLog[]
  branchPricing        BranchPricing[]
  wards                Ward[]

  @@index([tenantId])
  @@index([parentBranchId])
  @@map("branches")
}

// ==================== USER MANAGEMENT ====================

enum UserRole {
  SUPER_ADMIN
  HOSPITAL_ADMIN
  MEDICAL_DIRECTOR
  HEAD_NURSE
  DOCTOR
  NURSE
  PHARMACIST
  LAB_TECHNICIAN
  RADIOLOGIST
  RECEPTIONIST
  BILLING_OFFICER
  RECORDS_OFFICER
  HR_MANAGER
  ACCOUNTANT
  PATIENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum BranchAccessScope {
  PRIMARY_ONLY
  SPECIFIC_BRANCHES
  ALL_BRANCHES
  DEPARTMENT_ONLY
}

model User {
  id           String    @id @default(uuid())
  tenantId     String
  branchId     String?
  departmentId String?
  roleId       String?
  email        String
  phone        String?
  password     String
  firstName    String
  lastName     String
  middleName   String?
  gender       String?
  dateOfBirth  DateTime?
  profilePhoto String?

  // Legacy role field (kept for backward compatibility)
  role UserRole

  // Professional info
  specialization String?
  licenseNumber  String?

  // Branch access control
  branchAccessScope  BranchAccessScope @default(PRIMARY_ONLY)
  accessibleBranches String[]          @default([])
  currentBranchId    String?

  // Status
  status          UserStatus @default(ACTIVE)
  isActive        Boolean    @default(true)
  emailVerified   Boolean    @default(false)
  emailVerifiedAt DateTime?

  // Security - 2FA
  mfaEnabled    Boolean  @default(false)
  mfaSecret     String?
  mfaBackupCodes String[] @default([])

  // Password reset
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Session management
  lastLoginAt         DateTime?
  lastLoginIp         String?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Legacy field (kept for backward compatibility)
  refreshToken String?
  lastLogin    DateTime?

  // Audit
  createdBy     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deactivatedAt DateTime?
  deactivatedBy String?

  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch       Branch?     @relation(fields: [branchId], references: [id])
  department   Department? @relation("UserDepartment", fields: [departmentId], references: [id])
  roleRelation Role?       @relation("UserRole", fields: [roleId], references: [id])

  // Doctor-specific relations
  doctorSchedules       DoctorSchedule[]
  scheduleExceptions    ScheduleException[]
  appointmentsAsDoctor  Appointment[]       @relation("DoctorAppointments")
  encountersAsDoctor    Encounter[]         @relation("DoctorEncounters")
  prescriptionsAsDoctor Prescription[]      @relation("DoctorPrescriptions")
  queueEntries          QueueEntry[]
  aiSlotPredictions     AISlotPrediction[]

  auditLogs         AuditLog[]
  triageRecords     TriageRecord[]     @relation("NurseTriageRecords")
  userPermissions   UserPermission[]
  branchPermissions BranchPermission[]
  sessions          Session[]
  passwordHistory   PasswordHistory[]

  // Pharmacy relations
  dispensingRecords     DispensingRecord[]  @relation("DispensingUser")
  stockMovements        StockMovement[]     @relation("StockMovementUser")
  purchaseOrdersCreated PurchaseOrder[]     @relation("POCreatedBy")
  purchaseOrdersApproved PurchaseOrder[]    @relation("POApprovedBy")
  purchaseOrdersReceived PurchaseOrder[]    @relation("POReceivedBy")
  transfersRequested    StockTransfer[]     @relation("TransferRequestedBy")
  transfersApproved     StockTransfer[]     @relation("TransferApprovedBy")
  transfersReceived     StockTransfer[]     @relation("TransferReceivedBy")

  // Lab relations
  samplesCollected      LabSample[]         @relation("SampleCollectedBy")
  samplesReceived       LabSample[]         @relation("SampleReceivedBy")
  qcLogsPerformed       LabQCLog[]          @relation("QCPerformedBy")
  criticalAlertsNotified CriticalValueAlert[] @relation("CriticalNotifiedTo")
  criticalAlertsAcknowledged CriticalValueAlert[] @relation("CriticalAcknowledgedBy")

  // Inpatient relations
  admissionsAsAdmitting  Admission[]    @relation("AdmittingDoctor")
  admissionsAsAttending  Admission[]    @relation("AttendingDoctor")
  nursingNotes           NursingNote[]  @relation("NursingNotes")
  wardRoundsAsDoctor     WardRound[]    @relation("WardRounds")
  surgicalTeamRoles      SurgicalTeamMember[] @relation("SurgicalTeam")

  // CDS relations
  cdsOverrides           CDSAlertLog[]        @relation("CDSOverrides")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([role])
  @@index([roleId])
  @@index([departmentId])
  @@index([status])
  @@map("users")
}

model AuditLog {
  id             String   @id @default(uuid())
  tenantId       String?
  branchId       String?
  departmentId   String?
  userId         String?
  action         String
  resourceType   String?
  resourceId     String?
  oldData        Json?
  newData        Json?
  ipAddress      String?
  userAgent      String?
  requestMethod  String?
  requestPath    String?
  responseStatus Int?
  metadata       Json?
  createdAt      DateTime @default(now())

  tenant     Tenant?     @relation(fields: [tenantId], references: [id])
  branch     Branch?     @relation(fields: [branchId], references: [id])
  department Department? @relation(fields: [departmentId], references: [id])
  user       User?       @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@index([branchId, createdAt])
  @@index([departmentId])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([action])
  @@map("audit_logs")
}

// ==================== RBAC - ROLES & PERMISSIONS ====================

model Role {
  id           String   @id @default(uuid())
  tenantId     String?
  name         String
  displayName  String
  description  String?
  isSystemRole Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant      Tenant?          @relation(fields: [tenantId], references: [id])
  permissions RolePermission[]
  users       User[]           @relation("UserRole")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id                 String   @id @default(uuid())
  name               String   @unique
  displayName        String
  description        String?
  module             String
  isSystemPermission Boolean  @default(true)
  createdAt          DateTime @default(now())

  rolePermissions   RolePermission[]
  userPermissions   UserPermission[]
  branchPermissions BranchPermission[]

  @@index([module])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model BranchPermission {
  id           String    @id @default(uuid())
  userId       String
  branchId     String
  permissionId String
  grantType    String    @default("grant")
  grantedBy    String?
  reason       String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch     Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, branchId, permissionId])
  @@index([userId])
  @@index([branchId])
  @@map("branch_permissions")
}

model UserPermission {
  id           String    @id @default(uuid())
  userId       String
  permissionId String
  grantType    String    @default("grant")
  grantedBy    String?
  reason       String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@map("user_permissions")
}

// ==================== DEPARTMENTS ====================

model Department {
  id               String   @id @default(uuid())
  tenantId         String
  name             String
  code             String?
  description      String?
  headOfDepartment String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users        User[]        @relation("UserDepartment")
  auditLogs    AuditLog[]
  appointments Appointment[]
  encounters   Encounter[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("departments")
}

// ==================== SESSION MANAGEMENT ====================

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String
  ipAddress    String?
  userAgent    String?
  isActive     Boolean  @default(true)
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@index([expiresAt])
  @@map("sessions")
}

// ==================== PASSWORD HISTORY ====================

model PasswordHistory {
  id           String   @id @default(uuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@map("password_history")
}

// ==================== PATIENT MANAGEMENT ====================

enum Gender {
  MALE
  FEMALE
  OTHER
}

model Patient {
  id                String   @id @default(uuid())
  tenantId          String
  mrn               String
  title             String?
  firstName         String
  lastName          String
  otherNames        String?
  dateOfBirth       DateTime
  gender            Gender
  phonePrimary      String
  phoneSecondary    String?
  email             String?
  address           String
  ghanaPostGPS      String?
  city              String?
  region            String?
  country           String   @default("Ghana")
  ghanaCardNumber   String?
  photoUrl          String?
  photoThumbnail    String?
  bloodGroup        String?
  occupation        String?
  maritalStatus     String?
  religion          String?
  preferredLanguage String?  @default("English")
  nationality       String   @default("Ghanaian")

  // Portal access
  portalAccessEnabled Boolean   @default(false)
  portalPasswordHash  String?
  portalLastLogin     DateTime?

  // Biometrics
  fingerprintTemplate   String?
  fingerprintEnrolledAt DateTime?

  // Status and merge tracking
  isActive            Boolean   @default(true)
  isMerged            Boolean   @default(false)
  mergedIntoPatientId String?
  mergedAt            DateTime?
  mergedBy            String?

  // Registration info
  registrationSource   String?  @default("walk-in")
  registeredAtBranchId String?
  createdBy            String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tenant             Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  registeredAtBranch Branch? @relation("PatientRegisteredBranch", fields: [registeredAtBranchId], references: [id])

  // Related records
  contacts           PatientContact[]
  allergies          PatientAllergy[]
  medicalHistory     PatientMedicalHistory[]
  chronicConditions  PatientChronicCondition[]
  currentMedications PatientCurrentMedication[]
  relatives          PatientRelative[]
  documents          PatientDocument[]
  nhisInfo           PatientNHIS?
  appointments       Appointment[]
  queueEntries       QueueEntry[]
  encounters         Encounter[]
  prescriptions      Prescription[]
  labOrders          LabOrder[]
  invoices           Invoice[]
  auditLogs          PatientAuditLog[]
  triageRecords      TriageRecord[]
  vitalSignsHistory  VitalSignsHistory[]
  problemList        ProblemList[]
  radiologyOrders    RadiologyOrder[]
  dispensingRecords  DispensingRecord[]
  labSamples         LabSample[]
  criticalAlerts     CriticalValueAlert[]
  billingAccount     BillingAccount?
  nhisMember         NHISMember?
  insurancePolicies  InsurancePolicy[]
  insuranceClaims    InsuranceClaim[]
  admissions         Admission[]
  surgeries          Surgery[]
  pregnancies        Pregnancy[]
  erVisits           ERVisit[]
  cdsAlertLogs       CDSAlertLog[]

  @@unique([tenantId, mrn])
  @@unique([tenantId, ghanaCardNumber])
  @@index([tenantId, phonePrimary])
  @@index([tenantId, firstName, lastName])
  @@index([tenantId, dateOfBirth])
  @@index([isActive, isMerged])
  @@map("patients")
}

model PatientContact {
  id           String   @id @default(uuid())
  patientId    String
  name         String
  relationship String
  phone        String
  email        String?
  address      String?
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_contacts")
}

model PatientAllergy {
  id        String   @id @default(uuid())
  patientId String
  allergen  String
  reaction  String?
  severity  String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_allergies")
}

model PatientMedicalHistory {
  id            String    @id @default(uuid())
  patientId     String
  condition     String
  diagnosedDate DateTime?
  status        String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_medical_history")
}

model PatientRelative {
  id           String   @id @default(uuid())
  patientId    String
  name         String
  relationship String
  phone        String?
  ghanaCardNo  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_relatives")
}

model PatientNHIS {
  id         String    @id @default(uuid())
  patientId  String    @unique
  nhisNumber String
  scheme     String?
  expiryDate DateTime?
  status     String?   @default("Unknown")
  isVerified Boolean   @default(false)
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_nhis")
}

model PatientChronicCondition {
  id            String    @id @default(uuid())
  patientId     String
  conditionName String
  icd10Code     String?
  diagnosedDate DateTime?
  diagnosedBy   String?
  notes         String?
  isActive      Boolean   @default(true)
  createdBy     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_chronic_conditions")
}

model PatientCurrentMedication {
  id             String    @id @default(uuid())
  patientId      String
  medicationName String
  dosage         String?
  frequency      String?
  startedDate    DateTime?
  prescribedBy   String?
  reason         String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_current_medications")
}

model PatientDocument {
  id            String   @id @default(uuid())
  patientId     String
  documentType  String
  fileName      String
  fileUrl       String
  fileSizeBytes Int
  mimeType      String
  description   String?
  uploadedBy    String?
  uploadedAt    DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_documents")
}

model PatientAuditLog {
  id            String   @id @default(uuid())
  patientId     String
  action        String
  changedFields Json?
  oldValues     Json?
  newValues     Json?
  changedBy     String?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, createdAt])
  @@map("patient_audit_logs")
}

// ==================== APPOINTMENT SCHEDULING ====================

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  TRIAGED
  IN_PROGRESS
  COMPLETED
  RESCHEDULED
  CANCELLED
  NO_SHOW
}

enum BookingChannel {
  RECEPTION
  PORTAL
  PHONE
  WHATSAPP
  WALKIN
}

enum ExceptionType {
  LEAVE
  CONFERENCE
  HOLIDAY
  EMERGENCY
  HALF_DAY
}

enum QueuePriority {
  EMERGENCY
  URGENT
  SENIOR_CITIZEN
  PREGNANT
  WITH_CHILD
  REGULAR
  LATE_ARRIVAL
}

model AppointmentTypeConfig {
  id                     String   @id @default(uuid())
  tenantId               String
  name                   String
  description            String?
  defaultDurationMinutes Int      @default(30)
  colorCode              String   @default("#4CAF50")
  requiresPreparation    Boolean  @default(false)
  requiresFasting        Boolean  @default(false)
  isActive               Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  appointments  Appointment[]
  aiPredictions AISlotPrediction[]

  @@unique([tenantId, name])
  @@index([tenantId, isActive])
  @@map("appointment_type_configs")
}

model DoctorSchedule {
  id                      String   @id @default(uuid())
  tenantId                String
  doctorId                String
  dayOfWeek               Int
  startTime               String
  endTime                 String
  slotDuration            Int      @default(30)
  location                String?
  appointmentTypesAllowed String[]
  appointmentSplitPercent Int      @default(70)
  walkInSplitPercent      Int      @default(20)
  emergencySplitPercent   Int      @default(10)
  isActive                Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  doctor User @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek])
  @@index([tenantId, doctorId])
  @@map("doctor_schedules")
}

model ScheduleException {
  id              String        @id @default(uuid())
  tenantId        String
  doctorId        String
  date            DateTime
  exceptionType   ExceptionType
  isAvailable     Boolean       @default(false)
  customStartTime String?
  customEndTime   String?
  reason          String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  doctor User @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, date])
  @@index([tenantId, doctorId, date])
  @@map("schedule_exceptions")
}

model PublicHoliday {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  date        DateTime
  isRecurring Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@unique([tenantId, date])
  @@index([tenantId, date])
  @@map("public_holidays")
}

model Appointment {
  id                    String            @id @default(uuid())
  tenantId              String
  branchId              String
  departmentId          String?
  patientId             String
  doctorId              String
  appointmentTypeId     String?
  appointmentDate       DateTime
  appointmentTime       String
  endTime               String?
  duration              Int               @default(30)
  status                AppointmentStatus @default(SCHEDULED)
  bookingChannel        BookingChannel    @default(RECEPTION)
  chiefComplaint        String?
  specialInstructions   String?
  location              String?
  isWalkIn              Boolean           @default(false)
  queueNumber           String?
  priority              Int               @default(0)
  confirmedAt           DateTime?
  checkedInAt           DateTime?
  triagedAt             DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  actualDurationMinutes Int?
  noShowReason          String?
  cancelReason          String?
  cancelledBy           String?
  cancelledAt           DateTime?
  reminder24hSent       Boolean           @default(false)
  reminder2hSent        Boolean           @default(false)
  bookedBy              String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  branch            Branch                         @relation(fields: [branchId], references: [id])
  department        Department?                    @relation(fields: [departmentId], references: [id])
  patient           Patient                        @relation(fields: [patientId], references: [id])
  doctor            User                           @relation("DoctorAppointments", fields: [doctorId], references: [id])
  appointmentType   AppointmentTypeConfig?         @relation(fields: [appointmentTypeId], references: [id])
  encounter         Encounter?
  reminders         AppointmentReminder[]
  rescheduleHistory AppointmentRescheduleHistory[]
  triageRecord      TriageRecord?

  @@index([tenantId, appointmentDate])
  @@index([departmentId])
  @@index([doctorId, appointmentDate])
  @@index([patientId])
  @@index([status])
  @@index([isWalkIn, queueNumber, appointmentDate])
  @@map("appointments")
}

model QueueEntry {
  id                   String        @id @default(uuid())
  tenantId             String
  branchId             String
  patientId            String
  doctorId             String?
  appointmentId        String?
  queueNumber          String
  queuePosition        Int
  priority             QueuePriority @default(REGULAR)
  priorityScore        Int           @default(0)
  triageLevel          Int?
  estimatedWaitMinutes Int?
  status               String        @default("WAITING")
  smsSentTurnSoon      Boolean       @default(false)
  smsSentTurnNow       Boolean       @default(false)
  checkedInAt          DateTime      @default(now())
  calledAt             DateTime?
  completedAt          DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  User?   @relation(fields: [doctorId], references: [id])

  @@index([tenantId, branchId, status])
  @@index([doctorId, status, priorityScore])
  @@map("queue_entries")
}

model AppointmentReminder {
  id              String   @id @default(uuid())
  appointmentId   String
  reminderType    String
  sentAt          DateTime @default(now())
  sentVia         String
  messageText     String?
  deliveryStatus  String   @default("sent")
  patientResponse String?
  costGhs         Float?
  createdAt       DateTime @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@map("appointment_reminders")
}

model AppointmentRescheduleHistory {
  id            String   @id @default(uuid())
  appointmentId String
  oldDate       DateTime
  oldStartTime  String
  newDate       DateTime
  newStartTime  String
  reason        String?
  rescheduledBy String?
  rescheduledAt DateTime @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@map("appointment_reschedule_history")
}

model AISlotPrediction {
  id                       String   @id @default(uuid())
  tenantId                 String
  doctorId                 String
  appointmentTypeId        String
  dayOfWeek                Int?
  timeOfDay                String?
  predictedDurationMinutes Int
  confidenceScore          Float?
  lowerBoundMinutes        Int?
  upperBoundMinutes        Int?
  sampleSize               Int?
  modelVersion             String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  doctor          User                  @relation(fields: [doctorId], references: [id])
  appointmentType AppointmentTypeConfig @relation(fields: [appointmentTypeId], references: [id])

  @@unique([tenantId, doctorId, appointmentTypeId, dayOfWeek, timeOfDay])
  @@index([tenantId, doctorId])
  @@map("ai_slot_predictions")
}

// ==================== EMR / CLINICAL ====================

enum EncounterType {
  OUTPATIENT
  INPATIENT
  EMERGENCY
  TELEMEDICINE
  FOLLOW_UP
}

enum EncounterStatus {
  IN_PROGRESS
  COMPLETED
  SIGNED
  CANCELLED
}

enum Disposition {
  DISCHARGED
  ADMITTED
  TRANSFERRED
  AMA
  DECEASED
  FOLLOW_UP
}

model Encounter {
  id             String  @id @default(uuid())
  tenantId       String
  branchId       String
  departmentId   String?
  patientId      String
  doctorId       String
  appointmentId  String? @unique
  triageRecordId String?

  // Encounter metadata
  encounterType EncounterType @default(OUTPATIENT)
  encounterDate DateTime      @default(now())
  encounterTime String?
  location      String?
  templateUsed  String?

  // SOAP - Subjective
  chiefComplaint          String?
  historyOfPresentIllness String?
  reviewOfSystems         Json?
  pastMedicalHistory      String?
  medicationsReviewed     Boolean @default(false)
  allergiesReviewed       Boolean @default(false)
  socialHistory           String?
  familyHistory           String?

  // SOAP - Objective
  generalAppearance   String?
  physicalExamination Json?

  // SOAP - Assessment
  clinicalImpression    String?
  differentialDiagnoses String[]

  // SOAP - Plan
  treatmentPlan    String?
  patientEducation String?
  followUpPlan     String?
  followUpDate     DateTime?
  disposition      Disposition?

  // Status & Timestamps
  status                   EncounterStatus @default(IN_PROGRESS)
  startedAt                DateTime        @default(now())
  completedAt              DateTime?
  signedAt                 DateTime?
  signedBy                 String?
  encounterDurationMinutes Int?

  // Billing
  isBillable    Boolean @default(true)
  billingStatus String?

  // Legacy fields (kept for backward compatibility)
  assessment String?
  plan       String?
  notes      String?
  visitDate  DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch      Branch       @relation(fields: [branchId], references: [id])
  department  Department?  @relation(fields: [departmentId], references: [id])
  patient     Patient      @relation(fields: [patientId], references: [id])
  doctor      User         @relation("DoctorEncounters", fields: [doctorId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])

  vitalSigns      VitalSign[]
  diagnoses       Diagnosis[]
  prescriptions   Prescription[]
  labOrders       LabOrder[]
  radiologyOrders RadiologyOrder[]
  notesHistory    EncounterNotesHistory[]
  insuranceClaims InsuranceClaim[]

  @@index([tenantId, encounterDate])
  @@index([tenantId, visitDate])
  @@index([patientId])
  @@index([doctorId])
  @@index([departmentId])
  @@index([status])
  @@map("encounters")
}

model VitalSign {
  id                     String   @id @default(uuid())
  encounterId            String
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  temperature            Float?
  pulse                  Int?
  respiratoryRate        Int?
  oxygenSaturation       Float?
  weight                 Float?
  height                 Float?
  bmi                    Float?
  notes                  String?
  recordedAt             DateTime @default(now())
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@map("vital_signs")
}

enum DiagnosisType {
  PRIMARY
  SECONDARY
}

enum DiagnosisStatus {
  ACTIVE
  RESOLVED
  CHRONIC
}

model Diagnosis {
  id               String          @id @default(uuid())
  encounterId      String
  icd10Code        String
  icd10Description String
  diagnosisType    DiagnosisType   @default(PRIMARY)
  status           DiagnosisStatus @default(ACTIVE)
  onsetDate        DateTime?
  resolvedDate     DateTime?
  notes            String?
  rank             Int             @default(1)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@index([icd10Code])
  @@map("diagnoses")
}

// ==================== ICD-10 CODES ====================

model ICD10Code {
  code          String   @id
  description   String
  chapter       Int?
  category      String?
  isCommonGhana Boolean  @default(false)
  synonyms      String[]
  notes         String?
  createdAt     DateTime @default(now())

  @@index([isCommonGhana])
  @@map("icd10_codes")
}

// ==================== PROBLEM LIST ====================

model ProblemList {
  id                   String    @id @default(uuid())
  tenantId             String
  patientId            String
  icd10Code            String?
  icd10Description     String?
  problemName          String
  status               String    @default("active")
  onsetDate            DateTime?
  resolvedDate         DateTime?
  notes                String?
  addedBy              String?
  addedFromEncounterId String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, status])
  @@index([tenantId])
  @@map("problem_list")
}

// ==================== RADIOLOGY ORDERS ====================

enum OrderUrgency {
  ROUTINE
  URGENT
  STAT
}

enum RadiologyOrderStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model RadiologyStudyType {
  id           String   @id @default(uuid())
  tenantId     String?
  name         String
  code         String?
  modality     String   // X-RAY, CT, MRI, ULTRASOUND, FLUOROSCOPY, MAMMOGRAPHY, etc.
  bodyRegion   String?  // HEAD, CHEST, ABDOMEN, EXTREMITY, SPINE, etc.
  description  String?
  preparation  String?  // Patient prep instructions
  duration     Int?     // Estimated duration in minutes
  nhisApproved Boolean  @default(false)
  nhisPrice    Float?
  cashPrice    Float?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders RadiologyOrder[]

  @@unique([tenantId, code])
  @@index([modality])
  @@index([isActive])
  @@map("radiology_study_types")
}

model RadiologyOrder {
  id                 String               @id @default(uuid())
  tenantId           String
  branchId           String?
  encounterId        String
  patientId          String
  orderedBy          String
  studyTypeId        String?
  studyType          String
  bodyPart           String?
  laterality         String?
  urgency            OrderUrgency         @default(ROUTINE)
  clinicalIndication String?
  clinicalHistory    String?
  status             RadiologyOrderStatus @default(PENDING)
  orderedAt          DateTime             @default(now())
  scheduledAt        DateTime?
  scheduledRoom      String?
  performedBy        String?
  performedAt        DateTime?
  completedAt        DateTime?
  notes              String?
  findings           String?
  impression         String?
  reportedBy         String?
  reportedAt         DateTime?
  verifiedBy         String?
  verifiedAt         DateTime?
  contrastUsed       Boolean              @default(false)
  contrastType       String?
  radiationDose      Float?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  encounter  Encounter          @relation(fields: [encounterId], references: [id])
  patient    Patient            @relation(fields: [patientId], references: [id])
  studyRef   RadiologyStudyType? @relation(fields: [studyTypeId], references: [id])

  images  RadiologyImage[]
  report  RadiologyReport?

  @@index([encounterId])
  @@index([patientId])
  @@index([status])
  @@index([tenantId, orderedAt])
  @@map("radiology_orders")
}

model RadiologyImage {
  id          String   @id @default(uuid())
  orderId     String
  fileName    String
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  imageType   String?  // ORIGINAL, PROCESSED, ANNOTATED
  dicomStudyUid  String?
  dicomSeriesUid String?
  dicomInstanceUid String?
  thumbnailUrl String?
  uploadedBy  String?
  uploadedAt  DateTime @default(now())
  notes       String?
  createdAt   DateTime @default(now())

  order RadiologyOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([dicomStudyUid])
  @@map("radiology_images")
}

model RadiologyReport {
  id              String    @id @default(uuid())
  orderId         String    @unique
  templateId      String?
  technique       String?
  comparison      String?
  findings        String?
  impression      String?
  recommendation  String?
  criticalFinding Boolean   @default(false)
  criticalNotifiedTo String?
  criticalNotifiedAt DateTime?
  status          String    @default("DRAFT") // DRAFT, PRELIMINARY, FINAL, AMENDED, ADDENDUM
  reportedBy      String
  reportedAt      DateTime  @default(now())
  verifiedBy      String?
  verifiedAt      DateTime?
  amendedBy       String?
  amendedAt       DateTime?
  amendmentReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  order    RadiologyOrder          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  template RadiologyReportTemplate? @relation(fields: [templateId], references: [id])

  @@index([status])
  @@map("radiology_reports")
}

model RadiologyReportTemplate {
  id           String   @id @default(uuid())
  tenantId     String?
  name         String
  modality     String?
  bodyRegion   String?
  templateText String   // Default template with placeholders
  isActive     Boolean  @default(true)
  createdBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reports RadiologyReport[]

  @@index([modality])
  @@map("radiology_report_templates")
}

// ==================== ENCOUNTER NOTES HISTORY ====================

model EncounterNotesHistory {
  id          String   @id @default(uuid())
  encounterId String
  fieldName   String
  oldValue    String?
  newValue    String?
  editedBy    String
  editedAt    DateTime @default(now())
  editReason  String?

  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@map("encounter_notes_history")
}

// ==================== ENCOUNTER TEMPLATES ====================

model EncounterTemplate {
  id                   String   @id @default(uuid())
  tenantId             String?
  name                 String
  description          String?
  encounterType        String?
  specialty            String?
  chiefComplaintPrompt String?
  hpiPrompts           Json?
  rosDefaults          Json?
  physicalExamDefaults Json?
  commonDiagnoses      Json?
  commonOrders         Json?
  isSystemTemplate     Boolean  @default(false)
  isActive             Boolean  @default(true)
  createdBy            String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId, isActive])
  @@index([specialty])
  @@map("encounter_templates")
}

// ==================== PRESCRIPTION & PHARMACY ====================

model Drug {
  id           String   @id @default(uuid())
  tenantId     String?
  genericName  String
  brandName    String?
  strength     String?
  form         String?
  category     String?
  nhisApproved Boolean  @default(false)
  nhisPrice    Float?
  cashPrice    Float?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  prescriptionItems    PrescriptionItem[]
  stockItems           PharmacyStock[]
  dispensingRecords    DispensingRecord[]
  stockMovements       StockMovement[]
  purchaseOrderItems   PurchaseOrderItem[]
  stockTransferItems   StockTransferItem[]

  @@index([genericName])
  @@index([brandName])
  @@map("drugs")
}

model Prescription {
  id          String   @id @default(uuid())
  tenantId    String
  encounterId String
  patientId   String
  doctorId    String
  status      String   @default("PENDING")
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  encounter Encounter @relation(fields: [encounterId], references: [id])
  patient   Patient   @relation(fields: [patientId], references: [id])
  doctor    User      @relation("DoctorPrescriptions", fields: [doctorId], references: [id])

  items             PrescriptionItem[]
  dispensingRecords DispensingRecord[]

  @@index([tenantId])
  @@index([patientId])
  @@index([status])
  @@map("prescriptions")
}

model PrescriptionItem {
  id             String   @id @default(uuid())
  prescriptionId String
  drugId         String
  dosage         String
  frequency      String
  duration       String
  quantity       Int
  instructions   String?
  dispensedQty   Int      @default(0)
  status         String   @default("PENDING")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  prescription      Prescription       @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  drug              Drug               @relation(fields: [drugId], references: [id])
  dispensingRecords DispensingRecord[]

  @@index([prescriptionId])
  @@map("prescription_items")
}

model PharmacyStock {
  id           String    @id @default(uuid())
  tenantId     String
  branchId     String?
  drugId       String
  batchNumber  String?
  expiryDate   DateTime?
  quantity     Int       @default(0)
  reorderLevel Int       @default(10)
  costPrice    Float?
  sellingPrice Float?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  drug Drug @relation(fields: [drugId], references: [id])

  @@index([tenantId, drugId])
  @@index([expiryDate])
  @@map("pharmacy_stock")
}

// ==================== LABORATORY ====================

model LabTest {
  id             String   @id @default(uuid())
  tenantId       String?
  name           String
  code           String?
  category       String?
  sampleType     String?
  normalRange    String?
  unit           String?
  nhisApproved   Boolean  @default(false)
  nhisPrice      Float?
  cashPrice      Float?
  turnaroundTime Int?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  orderItems       LabOrderItem[]
  panelTests       LabPanelTest[]
  referenceRanges  LabReferenceRange[]
  qcLogs           LabQCLog[]
  parameters       LabTestParameter[]

  @@index([name])
  @@index([code])
  @@map("lab_tests")
}

model LabTestParameter {
  id          String   @id @default(uuid())
  testId      String
  name        String
  code        String?
  unit        String?
  normalRange String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  test LabTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@map("lab_test_parameters")
}

model LabOrder {
  id          String   @id @default(uuid())
  tenantId    String
  encounterId String?
  patientId   String
  orderedBy   String
  orderDate   DateTime @default(now())
  priority    String   @default("ROUTINE")
  status      String   @default("PENDING")
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  encounter Encounter? @relation(fields: [encounterId], references: [id])
  patient   Patient    @relation(fields: [patientId], references: [id])

  items   LabOrderItem[]
  samples LabSample[]

  @@index([tenantId, orderDate])
  @@index([patientId])
  @@index([status])
  @@map("lab_orders")
}

model LabOrderItem {
  id          String    @id @default(uuid())
  orderId     String
  testId      String
  status      String    @default("PENDING")
  result      String?
  resultValue Float?
  unit        String?
  normalRange String?
  isAbnormal  Boolean   @default(false)
  isCritical  Boolean   @default(false)
  performedBy String?
  performedAt DateTime?
  approvedBy  String?
  approvedAt  DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  order              LabOrder            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  test               LabTest             @relation(fields: [testId], references: [id])
  samples            LabSample[]
  criticalAlerts     CriticalValueAlert[]
  subResults         LabOrderItemResult[]

  @@index([orderId])
  @@map("lab_order_items")
}

model LabOrderItemResult {
  id            String   @id @default(uuid())
  orderItemId   String
  parameterName String
  parameterCode String?
  result        String?
  resultValue   Float?
  unit          String?
  normalRange   String?
  isAbnormal    Boolean  @default(false)
  isCritical    Boolean  @default(false)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  orderItem LabOrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@map("lab_order_item_results")
}

// ==================== BILLING & PAYMENTS ====================

model ServicePrice {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  category  String?
  cashPrice Float
  nhisPrice Float?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoiceItems InvoiceItem[]

  @@index([tenantId])
  @@map("service_prices")
}

model Invoice {
  id            String    @id @default(uuid())
  tenantId      String
  patientId     String
  invoiceNumber String
  invoiceDate   DateTime  @default(now())
  dueDate       DateTime?
  subtotal      Float     @default(0)
  discount      Float     @default(0)
  tax           Float     @default(0)
  total         Float     @default(0)
  amountPaid    Float     @default(0)
  balance       Float     @default(0)
  status        String    @default("DRAFT")
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  items    InvoiceItem[]
  payments Payment[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId, invoiceDate])
  @@index([patientId])
  @@index([status])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  serviceId   String?
  description String
  quantity    Int      @default(1)
  unitPrice   Float
  discount    Float    @default(0)
  total       Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service ServicePrice? @relation(fields: [serviceId], references: [id])

  @@index([invoiceId])
  @@map("invoice_items")
}

enum PaymentMethod {
  CASH
  CARD
  MTN_MOMO
  VODAFONE_CASH
  AIRTELTIGO_MONEY
  BANK_TRANSFER
  NHIS
  INSURANCE
}

model Payment {
  id             String        @id @default(uuid())
  tenantId       String
  invoiceId      String
  amount         Float
  paymentMethod  PaymentMethod
  transactionRef String?
  paymentDate    DateTime      @default(now())
  status         String        @default("COMPLETED")
  notes          String?
  receivedBy     String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([tenantId, paymentDate])
  @@index([invoiceId])
  @@map("payments")
}

model MobileMoneyTransaction {
  id            String    @id @default(uuid())
  tenantId      String
  invoiceId     String?
  amount        Float
  phone         String
  network       String
  transactionId String?
  externalRef   String?
  status        String    @default("PENDING")
  statusMessage String?
  initiatedAt   DateTime  @default(now())
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId, status])
  @@index([transactionId])
  @@map("mobile_money_transactions")
}

// ==================== NHIS CLAIMS ====================

model NHISTariff {
  id          String   @id @default(uuid())
  code        String   @unique
  description String
  category    String?
  price       Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  claimItems NHISClaimItem[]

  @@index([code])
  @@map("nhis_tariffs")
}

model NHISClaim {
  id              String    @id @default(uuid())
  tenantId        String
  patientId       String
  encounterId     String?
  claimNumber     String
  nhisNumber      String
  claimDate       DateTime  @default(now())
  totalAmount     Float     @default(0)
  approvedAmount  Float?
  status          String    @default("DRAFT")
  submittedAt     DateTime?
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  paidAt          DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  items NHISClaimItem[]

  @@unique([tenantId, claimNumber])
  @@index([tenantId, status])
  @@index([nhisNumber])
  @@map("nhis_claims")
}

model NHISClaimItem {
  id             String   @id @default(uuid())
  claimId        String
  tariffId       String
  quantity       Int      @default(1)
  amount         Float
  approvedAmount Float?
  status         String   @default("PENDING")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  claim  NHISClaim  @relation(fields: [claimId], references: [id], onDelete: Cascade)
  tariff NHISTariff @relation(fields: [tariffId], references: [id])

  @@index([claimId])
  @@map("nhis_claim_items")
}

// ==================== HR & PAYROLL ====================

model Employee {
  id           String    @id @default(uuid())
  tenantId     String
  userId       String?
  employeeNo   String
  firstName    String
  lastName     String
  email        String?
  phone        String
  dateOfBirth  DateTime?
  gender       Gender?
  address      String?
  department   String?
  designation  String?
  hireDate     DateTime?
  contractType String?
  bankName     String?
  bankAccount  String?
  ssnitNumber  String?
  tinNumber    String?
  basicSalary  Float?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  attendance        AttendanceRecord[]
  leaveApplications LeaveApplication[]
  payslips          Payslip[]

  @@unique([tenantId, employeeNo])
  @@index([tenantId])
  @@map("employees")
}

model AttendanceRecord {
  id         String    @id @default(uuid())
  employeeId String
  date       DateTime
  clockIn    DateTime?
  clockOut   DateTime?
  status     String    @default("PRESENT")
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, date])
  @@map("attendance_records")
}

model LeaveApplication {
  id         String    @id @default(uuid())
  employeeId String
  leaveType  String
  startDate  DateTime
  endDate    DateTime
  days       Int
  reason     String?
  status     String    @default("PENDING")
  approvedBy String?
  approvedAt DateTime?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([status])
  @@map("leave_applications")
}

model PayrollRun {
  id              String    @id @default(uuid())
  tenantId        String
  month           Int
  year            Int
  status          String    @default("DRAFT")
  totalGross      Float     @default(0)
  totalDeductions Float     @default(0)
  totalNet        Float     @default(0)
  processedAt     DateTime?
  processedBy     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  payslips Payslip[]

  @@unique([tenantId, month, year])
  @@index([tenantId])
  @@map("payroll_runs")
}

model Payslip {
  id              String   @id @default(uuid())
  payrollRunId    String
  employeeId      String
  basicSalary     Float
  allowances      Float    @default(0)
  grossSalary     Float
  ssnitEmployee   Float    @default(0)
  ssnitEmployer   Float    @default(0)
  incomeTax       Float    @default(0)
  otherDeductions Float    @default(0)
  totalDeductions Float
  netSalary       Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  payrollRun PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employee   Employee   @relation(fields: [employeeId], references: [id])

  @@index([payrollRunId])
  @@index([employeeId])
  @@map("payslips")
}

// ==================== REGISTRATION & SUBSCRIPTIONS ====================

model PendingRegistration {
  id            String  @id @default(uuid())
  fullName      String
  email         String  @unique
  phone         String  @unique
  hospitalName  String
  userRole      String
  userRoleOther String?

  // Step 2 - Hospital Details
  officialHospitalName  String?
  hospitalType          String?
  numberOfBeds          String?
  hospitalLicenseNumber String?
  ghsRegistrationNumber String?
  hospitalPhone         String?
  hospitalEmail         String?
  hospitalWebsite       String?
  streetAddress         String?
  ghanaPostGPS          String?
  region                String?
  city                  String?
  landmark              String?
  hospitalLicenseDoc    String?
  hospitalLogo          String?

  // Step 3 - Admin Account
  adminTitle          String?
  adminFirstName      String?
  adminLastName       String?
  adminOtherNames     String?
  adminPosition       String?
  professionalLicense String?
  passwordHash        String?
  enable2FA           Boolean @default(true)

  // Step 4 - Plan Selection
  selectedPlan String?
  billingCycle String?

  // Step 5 - Preferences
  primaryLanguage       String?
  dateFormat            String?
  operatingHours        Json?
  applyVAT              Boolean @default(true)
  applyNHIL             Boolean @default(true)
  applyGETFund          Boolean @default(true)
  branchName            String?
  branchAddress         String?
  referralSource        String?
  specificNeeds         String?
  agreeToTerms          Boolean @default(false)
  agreeToDataProcessing Boolean @default(false)

  // Metadata
  currentStep Int      @default(1)
  lastSavedAt DateTime @default(now())
  expiresAt   DateTime
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([phone])
  @@index([expiresAt])
  @@map("pending_registrations")
}

model VerificationCode {
  id          String    @id @default(uuid())
  identifier  String
  code        String
  type        String    @default("PHONE")
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  expiresAt   DateTime
  verifiedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([identifier, type])
  @@index([expiresAt])
  @@map("verification_codes")
}

model TenantSettings {
  id              String   @id @default(uuid())
  tenantId        String   @unique
  primaryLanguage String   @default("english")
  dateFormat      String   @default("DD/MM/YYYY")
  timeZone        String   @default("Africa/Accra")
  currency        String   @default("GHS")
  operatingHours  Json?
  applyVAT        Boolean  @default(true)
  applyNHIL       Boolean  @default(true)
  applyGETFund    Boolean  @default(true)
  vatRate         Float    @default(12.5)
  nhilRate        Float    @default(2.5)
  getfundRate     Float    @default(2.5)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("tenant_settings")
}

enum SubscriptionPlan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

model Subscription {
  id                 String             @id @default(uuid())
  tenantId           String             @unique
  plan               SubscriptionPlan   @default(STARTER)
  status             SubscriptionStatus @default(TRIAL)
  billingCycle       String             @default("monthly")
  trialStartDate     DateTime           @default(now())
  trialEndDate       DateTime
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelledAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([tenantId])
  @@index([status])
  @@map("subscriptions")
}

// ==================== TRIAGE & VITAL SIGNS ====================

enum TriageLevel {
  RED
  ORANGE
  YELLOW
  GREEN
  BLUE
}

enum TemperatureSite {
  ORAL
  AXILLARY
  TYMPANIC
  RECTAL
}

enum PulseRhythm {
  REGULAR
  IRREGULAR
}

enum RespiratoryPattern {
  REGULAR
  IRREGULAR
  LABORED
}

enum PainCharacter {
  SHARP
  DULL
  BURNING
  THROBBING
  CRAMPING
  ACHING
  STABBING
}

model TriageRecord {
  id            String   @id @default(uuid())
  tenantId      String
  patientId     String
  appointmentId String   @unique
  triagedBy     String
  triageDate    DateTime @default(now())
  triageTime    String

  // Vital Signs
  bpSystolic         Int?
  bpDiastolic        Int?
  temperature        Float?
  temperatureSite    TemperatureSite?
  pulseRate          Int?
  pulseRhythm        PulseRhythm?
  respiratoryRate    Int?
  respiratoryPattern RespiratoryPattern?
  spo2               Int?
  weight             Float?
  height             Int?
  bmi                Float?
  painScale          Int?
  painLocation       String?
  painCharacter      PainCharacter?

  // Assessment
  chiefComplaint     String
  symptomDuration    String?
  symptomSeverity    String?
  associatedSymptoms String[]
  clinicalNotes      String?

  // Triage Classification
  triageLevel          Int
  triageLevelName      String
  triageLevelColor     String
  suggestedTriageLevel Int?
  overrideReason       String?

  // Calculated values
  pulsePressure        Int?
  meanArterialPressure Float?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patient     Patient       @relation(fields: [patientId], references: [id])
  appointment Appointment   @relation(fields: [appointmentId], references: [id])
  nurse       User          @relation("NurseTriageRecords", fields: [triagedBy], references: [id])
  alerts      TriageAlert[]

  @@index([tenantId, triageDate])
  @@index([patientId, triageDate])
  @@index([appointmentId])
  @@index([triageLevel])
  @@map("triage_records")
}

model VitalSignsHistory {
  id         String   @id @default(uuid())
  tenantId   String
  patientId  String
  recordedAt DateTime @default(now())
  recordedBy String?
  source     String   @default("triage")

  // Vital Signs
  bpSystolic      Int?
  bpDiastolic     Int?
  temperature     Float?
  temperatureSite TemperatureSite?
  pulseRate       Int?
  pulseRhythm     PulseRhythm?
  respiratoryRate Int?
  spo2            Int?
  weight          Float?
  height          Int?
  bmi             Float?
  painScale       Int?

  // Reference to source record
  triageRecordId String?
  encounterId    String?

  createdAt DateTime @default(now())

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId, recordedAt])
  @@index([tenantId, recordedAt])
  @@map("vital_signs_history")
}

enum TriageAlertType {
  RED_TRIAGE
  CRITICAL_VITALS
  DETERIORATING
}

model TriageAlert {
  id             String          @id @default(uuid())
  tenantId       String
  triageRecordId String
  alertType      TriageAlertType
  alertMessage   String
  sentTo         String[]
  sentAt         DateTime        @default(now())
  acknowledgedBy String?
  acknowledgedAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  triageRecord TriageRecord @relation(fields: [triageRecordId], references: [id], onDelete: Cascade)

  @@index([tenantId, sentAt])
  @@index([triageRecordId])
  @@index([acknowledgedBy])
  @@map("triage_alerts")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String   // 'LAB_RESULT' | 'PRESCRIPTION' | 'APPOINTMENT' | 'SYSTEM'
  title     String
  message   String
  data      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationLog {
  id        String    @id @default(uuid())
  tenantId  String
  type      String
  title     String
  message   String
  data      Json?
  createdAt DateTime @default(now())
  
  @@map("notification_logs")
}

// ==================== PHARMACY MODULE ====================

model DispensingRecord {
  id                 String   @id @default(uuid())
  tenantId           String
  branchId           String
  prescriptionId     String
  prescriptionItemId String
  patientId          String
  drugId             String
  batchNumber        String?
  quantityDispensed  Int
  dispensedBy        String
  dispensedAt        DateTime @default(now())
  counselingNotes    String?
  createdAt          DateTime @default(now())

  prescription     Prescription     @relation(fields: [prescriptionId], references: [id])
  prescriptionItem PrescriptionItem @relation(fields: [prescriptionItemId], references: [id])
  patient          Patient          @relation(fields: [patientId], references: [id])
  drug             Drug             @relation(fields: [drugId], references: [id])
  dispensedByUser  User             @relation("DispensingUser", fields: [dispensedBy], references: [id])

  @@index([tenantId, dispensedAt])
  @@index([prescriptionId])
  @@index([patientId])
  @@map("dispensing_records")
}

model StockMovement {
  id            String   @id @default(uuid())
  tenantId      String
  branchId      String
  drugId        String
  batchNumber   String?
  movementType  String   // RECEIPT, DISPENSE, ADJUSTMENT, TRANSFER_IN, TRANSFER_OUT, EXPIRED, DAMAGED
  quantity      Int
  balanceBefore Int
  balanceAfter  Int
  referenceType String?
  referenceId   String?
  reason        String?
  performedBy   String
  performedAt   DateTime @default(now())
  createdAt     DateTime @default(now())

  drug            Drug @relation(fields: [drugId], references: [id])
  performedByUser User @relation("StockMovementUser", fields: [performedBy], references: [id])

  @@index([tenantId, branchId, performedAt])
  @@index([drugId])
  @@map("stock_movements")
}

model Supplier {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  contactPerson String?
  phone         String?
  email         String?
  address       String?
  paymentTerms  String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  purchaseOrders PurchaseOrder[]

  @@index([tenantId])
  @@map("suppliers")
}

model PurchaseOrder {
  id           String    @id @default(uuid())
  tenantId     String
  branchId     String
  supplierId   String
  orderNumber  String    @unique
  orderDate    DateTime  @default(now())
  expectedDate DateTime?
  status       String    @default("DRAFT")
  totalAmount  Float     @default(0)
  notes        String?
  createdBy    String
  approvedBy   String?
  approvedAt   DateTime?
  receivedBy   String?
  receivedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  supplier        Supplier            @relation(fields: [supplierId], references: [id])
  createdByUser   User                @relation("POCreatedBy", fields: [createdBy], references: [id])
  approvedByUser  User?               @relation("POApprovedBy", fields: [approvedBy], references: [id])
  receivedByUser  User?               @relation("POReceivedBy", fields: [receivedBy], references: [id])
  items           PurchaseOrderItem[]

  @@index([tenantId, orderDate])
  @@index([status])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String    @id @default(uuid())
  purchaseOrderId  String
  drugId           String
  quantityOrdered  Int
  quantityReceived Int       @default(0)
  unitCost         Float
  totalCost        Float
  batchNumber      String?
  expiryDate       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  drug          Drug          @relation(fields: [drugId], references: [id])

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

model StockTransfer {
  id             String    @id @default(uuid())
  tenantId       String
  fromBranchId   String
  toBranchId     String
  transferNumber String    @unique
  status         String    @default("PENDING")
  requestedBy    String
  requestedAt    DateTime  @default(now())
  approvedBy     String?
  approvedAt     DateTime?
  receivedBy     String?
  receivedAt     DateTime?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  requestedByUser User                @relation("TransferRequestedBy", fields: [requestedBy], references: [id])
  approvedByUser  User?               @relation("TransferApprovedBy", fields: [approvedBy], references: [id])
  receivedByUser  User?               @relation("TransferReceivedBy", fields: [receivedBy], references: [id])
  items           StockTransferItem[]

  @@index([tenantId])
  @@map("stock_transfers")
}

model StockTransferItem {
  id                  String   @id @default(uuid())
  transferId          String
  drugId              String
  batchNumber         String?
  quantityRequested   Int
  quantityTransferred Int      @default(0)
  createdAt           DateTime @default(now())

  transfer StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  drug     Drug          @relation(fields: [drugId], references: [id])

  @@index([transferId])
  @@map("stock_transfer_items")
}

// ==================== LABORATORY MODULE (Extended) ====================

model LabSample {
  id              String    @id @default(uuid())
  tenantId        String
  branchId        String
  orderId         String
  orderItemId     String
  patientId       String
  sampleNumber    String    @unique
  sampleType      String
  collectedBy     String
  collectedAt     DateTime  @default(now())
  collectionSite  String?
  volume          Float?
  condition       String    @default("ADEQUATE")
  status          String    @default("COLLECTED")
  receivedBy      String?
  receivedAt      DateTime?
  rejectionReason String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  order         LabOrder     @relation(fields: [orderId], references: [id])
  orderItem     LabOrderItem @relation(fields: [orderItemId], references: [id])
  patient       Patient      @relation(fields: [patientId], references: [id])
  collectedByUser User       @relation("SampleCollectedBy", fields: [collectedBy], references: [id])
  receivedByUser  User?      @relation("SampleReceivedBy", fields: [receivedBy], references: [id])

  @@index([tenantId, collectedAt])
  @@index([sampleNumber])
  @@index([orderId])
  @@map("lab_samples")
}

model LabPanel {
  id           String   @id @default(uuid())
  tenantId     String?
  name         String
  code         String?
  description  String?
  category     String?
  nhisApproved Boolean  @default(false)
  nhisPrice    Float?
  cashPrice    Float?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tests LabPanelTest[]

  @@index([name])
  @@map("lab_panels")
}

model LabPanelTest {
  id      String @id @default(uuid())
  panelId String
  testId  String

  panel LabPanel @relation(fields: [panelId], references: [id], onDelete: Cascade)
  test  LabTest  @relation(fields: [testId], references: [id])

  @@unique([panelId, testId])
  @@map("lab_panel_tests")
}

model LabReferenceRange {
  id           String   @id @default(uuid())
  testId       String
  gender       String?
  ageMinDays   Int?
  ageMaxDays   Int?
  lowValue     Float?
  highValue    Float?
  criticalLow  Float?
  criticalHigh Float?
  unit         String?
  notes        String?
  createdAt    DateTime @default(now())

  test LabTest @relation(fields: [testId], references: [id])

  @@index([testId])
  @@map("lab_reference_ranges")
}

model LabQCLog {
  id            String   @id @default(uuid())
  tenantId      String
  branchId      String
  testId        String
  equipmentId   String?
  lotNumber     String?
  level         String
  expectedValue Float
  observedValue Float
  isAcceptable  Boolean
  performedBy   String
  performedAt   DateTime @default(now())
  notes         String?
  createdAt     DateTime @default(now())

  test          LabTest @relation(fields: [testId], references: [id])
  performedByUser User  @relation("QCPerformedBy", fields: [performedBy], references: [id])

  @@index([tenantId, performedAt])
  @@map("lab_qc_logs")
}

model LabEquipment {
  id              String    @id @default(uuid())
  tenantId        String
  branchId        String
  name            String
  model           String?
  serialNumber    String?
  manufacturer    String?
  purchaseDate    DateTime?
  lastCalibration DateTime?
  nextCalibration DateTime?
  status          String    @default("ACTIVE")
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tenantId, branchId])
  @@map("lab_equipment")
}

model CriticalValueAlert {
  id             String    @id @default(uuid())
  tenantId       String
  orderItemId    String
  patientId      String
  testName       String
  resultValue    Float
  criticalType   String
  notifiedTo     String
  notifiedAt     DateTime  @default(now())
  acknowledgedBy String?
  acknowledgedAt DateTime?
  notes          String?
  createdAt      DateTime  @default(now())

  orderItem      LabOrderItem @relation(fields: [orderItemId], references: [id])
  patient        Patient      @relation(fields: [patientId], references: [id])
  notifiedToUser User         @relation("CriticalNotifiedTo", fields: [notifiedTo], references: [id])
  acknowledgedByUser User?    @relation("CriticalAcknowledgedBy", fields: [acknowledgedBy], references: [id])

  @@index([tenantId, notifiedAt])
  @@index([patientId])
  @@map("critical_value_alerts")
}

// ==================== BILLING MODULE (Extended) ====================

model BillingAccount {
  id           String   @id @default(uuid())
  tenantId     String
  patientId    String   @unique
  accountNumber String  @unique
  balance      Float    @default(0)
  creditLimit  Float    @default(0)
  paymentTerms String?
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient  Patient   @relation(fields: [patientId], references: [id])

  @@index([tenantId])
  @@index([accountNumber])
  @@map("billing_accounts")
}

model NHISMember {
  id                 String    @id @default(uuid())
  patientId          String    @unique
  membershipId       String
  membershipType     String
  validFrom          DateTime?
  validTo            DateTime?
  isActive           Boolean   @default(true)
  lastVerified       DateTime?
  verificationStatus String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([membershipId])
  @@map("nhis_members")
}

model InsuranceCompany {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  code          String
  contactPerson String?
  phone         String?
  email         String?
  address       String?
  paymentTerms  Int?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  policies InsurancePolicy[]
  claims   InsuranceClaim[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("insurance_companies")
}

model InsurancePolicy {
  id           String   @id @default(uuid())
  patientId    String
  companyId    String
  policyNumber String
  groupNumber  String?
  memberName   String?
  relationship String?
  validFrom    DateTime
  validTo      DateTime
  coverageLimit Float?
  usedAmount   Float    @default(0)
  copayPercent Float?
  copayAmount  Float?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient          @relation(fields: [patientId], references: [id])
  company InsuranceCompany @relation(fields: [companyId], references: [id])
  claims  InsuranceClaim[]

  @@index([patientId])
  @@index([policyNumber])
  @@map("insurance_policies")
}

model InsuranceClaim {
  id              String    @id @default(uuid())
  tenantId        String
  policyId        String
  companyId       String
  patientId       String
  encounterId     String?
  claimNumber     String    @unique
  claimDate       DateTime  @default(now())
  totalAmount     Float
  approvedAmount  Float?
  patientPortion  Float?
  status          String    @default("DRAFT")
  preAuthRequired Boolean   @default(false)
  preAuthNumber   String?
  preAuthStatus   String?
  submittedAt     DateTime?
  processedAt     DateTime?
  paidAt          DateTime?
  rejectionReason String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  policy   InsurancePolicy    @relation(fields: [policyId], references: [id])
  company  InsuranceCompany   @relation(fields: [companyId], references: [id])
  patient  Patient            @relation(fields: [patientId], references: [id])
  encounter Encounter?        @relation(fields: [encounterId], references: [id])
  items    InsuranceClaimItem[]

  @@index([tenantId, claimDate])
  @@index([status])
  @@map("insurance_claims")
}

model InsuranceClaimItem {
  id             String   @id @default(uuid())
  claimId        String
  serviceType    String
  description    String
  quantity       Int      @default(1)
  unitPrice      Float
  totalPrice     Float
  approvedAmount Float?
  createdAt      DateTime @default(now())

  claim InsuranceClaim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@map("insurance_claim_items")
}

// ==================== FINANCE & PRICING MODULE ====================

enum ServiceCategory {
  CLINICAL_SERVICES
  LABORATORY
  RADIOLOGY
  PHARMACY
  INPATIENT
  PACKAGES
}

model ServiceCatalog {
  id              String          @id @default(uuid())
  tenantId        String
  serviceCode     String
  serviceName     String
  category        ServiceCategory
  subcategory     String?
  description     String?

  // Pricing
  basePrice       Float
  costPrice       Float?          
  targetProfitPercentage Float?
  costCalculationMethod  String?  @default("manual")
  lastCostUpdate  DateTime?
  unit            String          @default("per_visit")

  // NHIS
  isNhisCovered   Boolean         @default(false)
  nhisPrice       Float?
  nhisCode        String?
  requiresNhisPreauth Boolean     @default(false)

  // Tax
  isTaxable       Boolean         @default(false)
  taxRate         Float           @default(0)

  // Settings
  isActive        Boolean         @default(true)
  effectiveFrom   DateTime?
  effectiveTo     DateTime?

  // Metadata
  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branchPricing   BranchPricing[]
  insurancePricing InsurancePricing[]
  priceHistory    PriceHistory[]
  costComponents  CostComponent[]
  costHistory     CostHistory[]

  @@unique([tenantId, serviceCode])
  @@index([tenantId, category])
  @@index([tenantId, isActive])
  @@map("service_catalog")
}

model BranchPricing {
  id              String    @id @default(uuid())
  branchId        String
  serviceId       String
  branchPrice     Float
  reason          String?

  effectiveFrom   DateTime  @default(now())
  effectiveTo     DateTime?
  isActive        Boolean   @default(true)

  createdBy       String?
  createdAt       DateTime  @default(now())

  branch          Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  service         ServiceCatalog @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([branchId, serviceId, effectiveFrom])
  @@index([branchId])
  @@index([serviceId])
  @@map("branch_pricing")
}

model InsurancePricing {
  id                String    @id @default(uuid())
  tenantId          String
  insuranceCompanyId String?
  insuranceCompanyName String
  serviceId         String

  insurancePrice    Float
  discountPercentage Float?

  contractStartDate DateTime
  contractEndDate   DateTime?
  isActive          Boolean   @default(true)

  createdAt         DateTime  @default(now())

  service           ServiceCatalog @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([tenantId, insuranceCompanyName])
  @@index([serviceId])
  @@map("insurance_pricing")
}

model DiscountScheme {
  id                String   @id @default(uuid())
  tenantId          String
  schemeName        String
  discountType      String   @default("percentage")
  discountValue     Float
  appliesTo         String   @default("all_services")
  eligibilityCriteria String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive])
  @@map("discount_schemes")
}

model PriceHistory {
  id              String   @id @default(uuid())
  serviceId       String
  oldPrice        Float
  newPrice        Float
  changeReason    String?
  effectiveDate   DateTime @default(now())
  changedBy       String?
  createdAt       DateTime @default(now())

  service         ServiceCatalog @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId, effectiveDate])
  @@map("price_history")
}

model CategoryProfitSettings {
  id                      String   @id @default(uuid())
  tenantId                String
  category                String
  subcategory             String?
  targetProfitPercentage  Float
  minimumProfitPercentage Float?
  pricingStrategy         String   @default("cost_plus")
  autoAdjustPrices        Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  tenant                  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, category, subcategory])
  @@index([tenantId])
  @@map("category_profit_settings")
}

model CostComponent {
  id              String   @id @default(uuid())
  serviceId       String
  componentType   String
  componentName   String
  costAmount      Float
  percentageOfTotal Float?
  isVariable      Boolean  @default(false)
  notes           String?
  createdAt       DateTime @default(now())

  service         ServiceCatalog @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@map("cost_components")
}

model CostHistory {
  id                    String   @id @default(uuid())
  serviceId             String
  oldCost               Float
  newCost               Float
  costChangeAmount      Float?
  costChangePercentage  Float?
  changeReason          String?
  effectiveDate         DateTime @default(now())
  recordedBy            String?
  createdAt             DateTime @default(now())

  service               ServiceCatalog @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId, effectiveDate])
  @@map("cost_history")
}

// ==================== INPATIENT / ADMISSION MODULE ====================

enum WardType {
  GENERAL
  PRIVATE
  SEMI_PRIVATE
  ICU
  HDU
  NICU
  PEDIATRIC
  MATERNITY
  SURGICAL
  ISOLATION
  EMERGENCY
}

enum BedStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  MAINTENANCE
  CLEANING
  OUT_OF_SERVICE
}

enum AdmissionStatus {
  PENDING
  ADMITTED
  TRANSFERRED
  DISCHARGED
  DECEASED
  CANCELLED
}

enum DischargeType {
  NORMAL
  AGAINST_MEDICAL_ADVICE
  TRANSFERRED
  DECEASED
  ABSCONDED
}

model Ward {
  id          String   @id @default(uuid())
  tenantId    String
  branchId    String
  name        String
  code        String
  wardType    WardType @default(GENERAL)
  floor       String?
  building    String?
  totalBeds   Int      @default(0)
  description String?
  nurseStation String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branch      Branch   @relation(fields: [branchId], references: [id])
  beds        Bed[]
  admissions  Admission[]

  @@unique([tenantId, branchId, code])
  @@index([tenantId, branchId])
  @@map("wards")
}

model Bed {
  id          String    @id @default(uuid())
  wardId      String
  bedNumber   String
  bedType     String    @default("standard")
  status      BedStatus @default(AVAILABLE)
  features    String[]
  dailyRate   Float?
  isActive    Boolean   @default(true)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  ward        Ward      @relation(fields: [wardId], references: [id], onDelete: Cascade)
  admissions  Admission[]
  transfers   BedTransfer[]

  @@unique([wardId, bedNumber])
  @@index([wardId, status])
  @@map("beds")
}

model Admission {
  id              String          @id @default(uuid())
  tenantId        String
  branchId        String
  patientId       String
  wardId          String
  bedId           String
  encounterId     String?
  admittingDoctorId String
  attendingDoctorId String?

  admissionNumber String
  admissionDate   DateTime        @default(now())
  admissionReason String
  admissionSource String          @default("OPD")
  status          AdmissionStatus @default(ADMITTED)
  priority        String          @default("routine")

  // Diagnosis
  primaryDiagnosis    String?
  secondaryDiagnoses  String[]
  admissionNotes      String?

  // Diet & Activity
  dietOrders      String?
  activityLevel   String?
  precautions     String[]

  // Discharge info
  dischargeDate       DateTime?
  dischargeType       DischargeType?
  dischargeSummary    String?
  dischargeNotes      String?
  dischargeMedications String?
  dischargedBy        String?
  followUpDate        DateTime?
  followUpInstructions String?

  // Billing
  estimatedStay   Int?
  actualStay      Int?
  totalCharges    Float?

  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  patient         Patient         @relation(fields: [patientId], references: [id])
  ward            Ward            @relation(fields: [wardId], references: [id])
  bed             Bed             @relation(fields: [bedId], references: [id])
  admittingDoctor User            @relation("AdmittingDoctor", fields: [admittingDoctorId], references: [id])
  attendingDoctor User?           @relation("AttendingDoctor", fields: [attendingDoctorId], references: [id])

  nursingNotes    NursingNote[]
  wardRounds      WardRound[]
  bedTransfers    BedTransfer[]
  medicationAdministrations MedicationAdministration[]
  vitalCharts     InpatientVitalChart[]
  carePlans       CarePlan[]

  @@unique([tenantId, admissionNumber])
  @@index([tenantId, status])
  @@index([patientId, status])
  @@index([wardId, status])
  @@index([bedId])
  @@map("admissions")
}

model NursingNote {
  id            String   @id @default(uuid())
  admissionId   String
  nurseId       String
  noteType      String   @default("progress")
  content       String
  painLevel     Int?
  consciousness String?
  isHandover    Boolean  @default(false)
  shift         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  admission     Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  nurse         User      @relation("NursingNotes", fields: [nurseId], references: [id])

  @@index([admissionId, createdAt])
  @@map("nursing_notes")
}

model WardRound {
  id            String   @id @default(uuid())
  admissionId   String
  doctorId      String
  roundDate     DateTime @default(now())
  findings      String
  instructions  String?
  planChanges   String?
  dietChanges   String?
  medicationChanges String?
  nextRoundDate DateTime?
  createdAt     DateTime @default(now())

  admission     Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  doctor        User      @relation("WardRounds", fields: [doctorId], references: [id])

  @@index([admissionId, roundDate])
  @@map("ward_rounds")
}

model BedTransfer {
  id              String   @id @default(uuid())
  admissionId     String
  fromBedId       String
  toBedId         String
  reason          String
  transferDate    DateTime @default(now())
  authorizedBy    String?
  createdAt       DateTime @default(now())

  admission       Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  fromBed         Bed       @relation(fields: [fromBedId], references: [id])

  @@index([admissionId])
  @@map("bed_transfers")
}

model MedicationAdministration {
  id              String   @id @default(uuid())
  admissionId     String
  medicationName  String
  dosage          String
  route           String
  frequency       String
  scheduledTime   DateTime
  administeredAt  DateTime?
  administeredBy  String?
  status          String   @default("scheduled")
  notes           String?
  refusedReason   String?
  createdAt       DateTime @default(now())

  admission       Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@index([admissionId, scheduledTime])
  @@index([status])
  @@map("medication_administrations")
}

model InpatientVitalChart {
  id                     String   @id @default(uuid())
  admissionId            String
  recordedBy             String
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  temperature            Float?
  pulse                  Int?
  respiratoryRate        Int?
  oxygenSaturation       Float?
  bloodGlucose           Float?
  painLevel              Int?
  intakeOral             Float?
  intakeIV               Float?
  outputUrine            Float?
  outputOther            Float?
  consciousness          String?
  notes                  String?
  recordedAt             DateTime @default(now())

  admission              Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@index([admissionId, recordedAt])
  @@map("inpatient_vital_charts")
}

model CarePlan {
  id            String   @id @default(uuid())
  admissionId   String
  problem       String
  goal          String
  interventions String
  evaluation    String?
  status        String   @default("active")
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  admission     Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@index([admissionId, status])
  @@map("care_plans")
}

// ==================== OPERATING THEATRE / SURGERY ====================

enum TheatreStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  CLEANING
  RESERVED
}

enum SurgeryStatus {
  REQUESTED
  SCHEDULED
  PRE_OP
  IN_PROGRESS
  POST_OP
  COMPLETED
  CANCELLED
}

enum SurgeryUrgency {
  ELECTIVE
  URGENT
  EMERGENCY
}

model OperatingTheatre {
  id           String        @id @default(uuid())
  tenantId     String
  branchId     String?
  name         String
  code         String?
  theatreType  String?       // GENERAL, ORTHO, CARDIAC, NEURO, OB_GYN, OPHTHALMIC, ENT, etc.
  floor        String?
  equipment    Json?
  status       TheatreStatus @default(AVAILABLE)
  isActive     Boolean       @default(true)
  notes        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  surgeries    Surgery[]

  @@unique([tenantId, code])
  @@index([tenantId, status])
  @@map("operating_theatres")
}

model SurgeryType {
  id           String   @id @default(uuid())
  tenantId     String?
  name         String
  code         String?
  category     String?  // GENERAL, ORTHO, CARDIAC, NEURO, OB_GYN, etc.
  description  String?
  estimatedDuration Int? // minutes
  anesthesiaType    String? // LOCAL, REGIONAL, GENERAL, SEDATION
  nhisApproved Boolean  @default(false)
  nhisPrice    Float?
  cashPrice    Float?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  surgeries    Surgery[]

  @@unique([tenantId, code])
  @@index([category])
  @@map("surgery_types")
}

model Surgery {
  id                String        @id @default(uuid())
  tenantId          String
  branchId          String?
  patientId         String
  encounterId       String?
  admissionId       String?
  theatreId         String?
  surgeryTypeId     String?
  procedureName     String
  procedureCode     String?
  urgency           SurgeryUrgency @default(ELECTIVE)
  status            SurgeryStatus  @default(REQUESTED)

  // Scheduling
  requestedBy       String
  requestedAt       DateTime      @default(now())
  scheduledDate     DateTime?
  scheduledStartTime String?
  scheduledEndTime  String?
  actualStartTime   DateTime?
  actualEndTime     DateTime?

  // Clinical
  preOpDiagnosis    String?
  postOpDiagnosis   String?
  indication        String?
  laterality        String?       // LEFT, RIGHT, BILATERAL, N/A
  anesthesiaType    String?
  anesthesiaStartTime DateTime?
  anesthesiaEndTime DateTime?
  estimatedBloodLoss Float?
  complications     String?
  specimens         String?       // Specimens sent to pathology
  implants          String?
  drainType         String?

  // Notes
  preOpNotes        String?
  operativeNotes    String?
  postOpNotes       String?
  postOpInstructions String?

  // Consent
  consentObtained   Boolean       @default(false)
  consentBy         String?
  consentAt         DateTime?

  // Outcome
  outcome           String?       // SUCCESSFUL, COMPLICATED, ABORTED
  dischargeFromTheatre DateTime?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  patient           Patient       @relation(fields: [patientId], references: [id])
  theatre           OperatingTheatre? @relation(fields: [theatreId], references: [id])
  surgeryType       SurgeryType?  @relation(fields: [surgeryTypeId], references: [id])

  team              SurgicalTeamMember[]
  checklistItems    SurgicalChecklist[]

  @@index([tenantId, scheduledDate])
  @@index([patientId])
  @@index([status])
  @@index([theatreId, scheduledDate])
  @@map("surgeries")
}

model SurgicalTeamMember {
  id          String   @id @default(uuid())
  surgeryId   String
  userId      String
  role        String   // LEAD_SURGEON, ASSISTANT_SURGEON, ANESTHETIST, SCRUB_NURSE, CIRCULATING_NURSE
  isPrimary   Boolean  @default(false)
  notes       String?
  createdAt   DateTime @default(now())

  surgery     Surgery  @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  user        User     @relation("SurgicalTeam", fields: [userId], references: [id])

  @@unique([surgeryId, userId, role])
  @@index([surgeryId])
  @@map("surgical_team_members")
}

model SurgicalChecklist {
  id          String    @id @default(uuid())
  surgeryId   String
  phase       String    // SIGN_IN, TIME_OUT, SIGN_OUT (WHO Surgical Safety Checklist)
  item        String
  isChecked   Boolean   @default(false)
  checkedBy   String?
  checkedAt   DateTime?
  notes       String?
  createdAt   DateTime  @default(now())

  surgery     Surgery   @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([surgeryId, phase])
  @@map("surgical_checklists")
}

// ==================== MATERNITY / OBSTETRICS ====================

enum PregnancyStatus {
  ACTIVE
  DELIVERED
  MISCARRIAGE
  STILLBIRTH
  ECTOPIC
  TERMINATED
}

enum DeliveryMode {
  SVD           // Spontaneous Vaginal Delivery
  ASSISTED      // Vacuum/Forceps
  ELECTIVE_CS   // Elective Caesarean Section
  EMERGENCY_CS  // Emergency Caesarean Section
}

enum NewbornStatus {
  ALIVE
  STILLBORN
  NEONATAL_DEATH
}

model Pregnancy {
  id              String          @id @default(uuid())
  tenantId        String
  branchId        String?
  patientId       String
  gravida         Int             // Total pregnancies
  para            Int             // Total deliveries
  lmp             DateTime?       // Last Menstrual Period
  edd             DateTime?       // Estimated Due Date
  gestationalAge  Int?            // weeks at registration
  bloodGroup      String?
  rhFactor        String?
  riskLevel       String          @default("LOW") // LOW, MODERATE, HIGH
  riskFactors     String[]
  status          PregnancyStatus @default(ACTIVE)
  registeredBy    String
  registeredAt    DateTime        @default(now())
  outcome         String?
  outcomeDate     DateTime?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  patient         Patient         @relation(fields: [patientId], references: [id])

  ancVisits       ANCVisit[]
  deliveryRecord  DeliveryRecord?
  postnatalVisits PostnatalVisit[]

  @@index([tenantId, status])
  @@index([patientId])
  @@index([edd])
  @@map("pregnancies")
}

model ANCVisit {
  id              String   @id @default(uuid())
  pregnancyId     String
  visitNumber     Int
  visitDate       DateTime @default(now())
  gestationalAge  Int?     // weeks
  weight          Float?
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  fundalHeight    Float?   // cm
  fetalHeartRate  Int?     // bpm
  fetalPresentation String? // CEPHALIC, BREECH, TRANSVERSE
  fetalMovement   String?  // PRESENT, ABSENT, REDUCED
  edema           String?  // NONE, MILD, MODERATE, SEVERE
  proteinuria     String?  // NEGATIVE, TRACE, +, ++, +++
  hemoglobin      Float?
  urineTest       String?
  complaints      String?
  findings        String?
  plan            String?
  nextVisitDate   DateTime?
  attendedBy      String
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  pregnancy       Pregnancy @relation(fields: [pregnancyId], references: [id], onDelete: Cascade)

  @@index([pregnancyId, visitDate])
  @@map("anc_visits")
}

model DeliveryRecord {
  id                  String       @id @default(uuid())
  pregnancyId         String       @unique
  tenantId            String
  branchId            String?
  deliveryDate        DateTime
  deliveryTime        String?
  gestationalAgeAtDelivery Int?
  deliveryMode        DeliveryMode @default(SVD)
  placeOfDelivery     String?      // HOSPITAL, HOME, TRANSIT
  durationOfLabourHours Float?
  inductionUsed       Boolean      @default(false)
  inductionMethod     String?
  augmentationUsed    Boolean      @default(false)
  episiotomy          Boolean      @default(false)
  perinealTear        String?      // NONE, FIRST, SECOND, THIRD, FOURTH
  placentaDelivered   Boolean      @default(true)
  placentaComplete    Boolean      @default(true)
  estimatedBloodLoss  Float?       // ml
  complications       String?
  deliveredBy         String
  assistedBy          String?
  anesthetist         String?
  notes               String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  pregnancy           Pregnancy    @relation(fields: [pregnancyId], references: [id])
  partographEntries   PartographEntry[]

  newborns            NewbornRecord[]

  @@index([tenantId, deliveryDate])
  @@map("delivery_records")
}

model NewbornRecord {
  id                String        @id @default(uuid())
  deliveryRecordId  String
  tenantId          String
  gender            String
  birthWeight       Float?        // grams
  birthLength       Float?        // cm
  headCircumference Float?        // cm
  apgarScore1Min    Int?
  apgarScore5Min    Int?
  apgarScore10Min   Int?
  resuscitationNeeded Boolean     @default(false)
  resuscitationDetails String?
  birthDefects      String?
  status            NewbornStatus @default(ALIVE)
  vitaminKGiven     Boolean       @default(false)
  bcgGiven          Boolean       @default(false)
  opv0Given         Boolean       @default(false)
  breastfeedingInitiated Boolean  @default(false)
  breastfeedingTime String?       // Time after birth
  notes             String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  deliveryRecord    DeliveryRecord @relation(fields: [deliveryRecordId], references: [id], onDelete: Cascade)

  @@index([deliveryRecordId])
  @@map("newborn_records")
}

model PartographEntry {
  id                String   @id @default(uuid())
  deliveryRecordId  String
  recordedAt        DateTime @default(now())
  hoursFromStart    Float    // hours since active labour started
  // Cervical dilation (cm) - plotted on partograph
  cervicalDilation  Float?
  // Descent of head (fifths palpable above brim: 5/5 to 0/5)
  descentOfHead     Int?
  // Contractions per 10 minutes
  contractionsPerTen Int?
  contractionDuration String? // <20s, 20-40s, >40s
  // Amniotic fluid
  membranes         String?  // INTACT, RUPTURED
  liquorColor       String?  // CLEAR, MECONIUM_LIGHT, MECONIUM_THICK, BLOODY, ABSENT
  // Moulding
  moulding          String?  // NONE, PLUS1, PLUS2, PLUS3
  // Vital signs
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  pulse             Int?
  temperature       Float?
  // Urine
  urineVolume       String?  // ADEQUATE, REDUCED, NIL
  urineProtein      String?  // NONE, TRACE, PLUS1, PLUS2, PLUS3
  urineAcetone      String?  // NONE, TRACE, POSITIVE
  // Oxytocin
  oxytocinDose      Float?   // mIU/min
  // Drugs/IV fluids
  drugsGiven        String?
  ivFluids          String?
  // Fetal heart rate
  fetalHeartRate    Int?
  // Notes
  notes             String?
  recordedBy        String
  createdAt         DateTime @default(now())

  deliveryRecord    DeliveryRecord @relation(fields: [deliveryRecordId], references: [id], onDelete: Cascade)

  @@index([deliveryRecordId, hoursFromStart])
  @@map("partograph_entries")
}

model PostnatalVisit {
  id              String   @id @default(uuid())
  pregnancyId     String
  visitNumber     Int
  visitDate       DateTime @default(now())
  daysPostpartum  Int?
  motherCondition String?  // GOOD, FAIR, POOR
  uterusInvolution String? // NORMAL, SUBINVOLUTION
  lochia          String?  // NORMAL, HEAVY, OFFENSIVE
  breastCondition String?  // NORMAL, ENGORGED, MASTITIS, CRACKED_NIPPLES
  breastfeeding   String?  // EXCLUSIVE, MIXED, FORMULA
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  temperature     Float?
  episiotomyHealing String? // GOOD, INFECTED, DEHISCENCE
  csWoundHealing  String?  // GOOD, INFECTED, DEHISCENCE
  emotionalState  String?  // NORMAL, BABY_BLUES, DEPRESSION_SUSPECTED
  contraceptionDiscussed Boolean @default(false)
  contraceptionMethod    String?
  babyWeight      Float?
  babyCondition   String?
  immunizationsGiven String?
  findings        String?
  plan            String?
  attendedBy      String
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  pregnancy       Pregnancy @relation(fields: [pregnancyId], references: [id], onDelete: Cascade)

  @@index([pregnancyId, visitDate])
  @@map("postnatal_visits")
}

// ==================== EMERGENCY DEPARTMENT ====================

enum ERTriageCategory {
  RED       // Immediate / Resuscitation
  ORANGE    // Very Urgent
  YELLOW    // Urgent
  GREEN     // Standard
  BLUE      // Non-Urgent
}

enum ERVisitStatus {
  REGISTERED
  TRIAGED
  AWAITING_DOCTOR
  IN_TREATMENT
  OBSERVATION
  ADMITTED
  DISCHARGED
  TRANSFERRED
  LEFT_AMA       // Left Against Medical Advice
  DECEASED
}

model ERVisit {
  id                String          @id @default(uuid())
  tenantId          String
  branchId          String?
  patientId         String
  encounterId       String?
  arrivalMode       String?         // AMBULANCE, WALK_IN, POLICE, REFERRAL
  arrivalTime       DateTime        @default(now())
  chiefComplaint    String
  triageCategory    ERTriageCategory?
  triageTime        DateTime?
  triagedBy         String?
  status            ERVisitStatus   @default(REGISTERED)
  assignedDoctor    String?
  assignedNurse     String?
  bedLocation       String?         // ER bed/bay assignment
  acuityScore       Int?            // 1-5
  painScore         Int?            // 0-10

  // Vitals at arrival
  temperature       Float?
  heartRate         Int?
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  respiratoryRate   Int?
  oxygenSaturation  Float?
  glasgowComaScale  Int?

  // Clinical
  allergies         String?
  currentMedications String?
  primaryDiagnosis  String?
  secondaryDiagnosis String?
  procedures        String?
  treatmentNotes    String?

  // Disposition
  disposition       String?         // DISCHARGED, ADMITTED, TRANSFERRED, DECEASED
  dispositionTime   DateTime?
  dispositionNotes  String?
  admissionId       String?
  transferTo        String?         // Facility name if transferred

  // Trauma
  isTrauma          Boolean         @default(false)
  traumaMechanism   String?         // MVA, FALL, ASSAULT, BURN, etc.
  traumaScore       Int?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  patient           Patient         @relation(fields: [patientId], references: [id])

  erNotes           ERNote[]

  @@index([tenantId, arrivalTime])
  @@index([tenantId, status])
  @@index([patientId])
  @@index([triageCategory])
  @@map("er_visits")
}

model ERNote {
  id          String   @id @default(uuid())
  erVisitId   String
  authorId    String
  noteType    String   // TRIAGE, DOCTOR, NURSING, PROCEDURE, DISPOSITION
  content     String
  createdAt   DateTime @default(now())

  erVisit     ERVisit  @relation(fields: [erVisitId], references: [id], onDelete: Cascade)

  @@index([erVisitId, createdAt])
  @@map("er_notes")
}

// ==================== GENERAL INVENTORY ====================

enum InventoryTransactionType {
  RECEIVED
  ISSUED
  RETURNED
  ADJUSTED
  DAMAGED
  EXPIRED
  TRANSFERRED
}

model InventoryCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  code        String?
  description String?
  parentId    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items       InventoryItem[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("inventory_categories")
}

model InventoryItem {
  id              String   @id @default(uuid())
  tenantId        String
  branchId        String?
  categoryId      String?
  name            String
  code            String?
  description     String?
  unit            String   // PIECE, BOX, PACK, ROLL, LITER, KG, etc.
  currentStock    Int      @default(0)
  reorderLevel    Int      @default(0)
  reorderQuantity Int      @default(0)
  unitCost        Float?
  location        String?  // Storage location
  supplier        String?
  isActive        Boolean  @default(true)
  lastRestocked   DateTime?
  expiryDate      DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  category        InventoryCategory? @relation(fields: [categoryId], references: [id])
  transactions    InventoryTransaction[]

  @@unique([tenantId, code])
  @@index([tenantId, categoryId])
  @@index([tenantId, currentStock])
  @@map("inventory_items")
}

model InventoryTransaction {
  id            String                   @id @default(uuid())
  tenantId      String
  branchId      String?
  itemId        String
  type          InventoryTransactionType
  quantity      Int
  previousStock Int
  newStock      Int
  unitCost      Float?
  totalCost     Float?
  reference     String?   // PO number, requisition number, etc.
  reason        String?
  performedBy   String
  notes         String?
  createdAt     DateTime  @default(now())

  item          InventoryItem @relation(fields: [itemId], references: [id])

  @@index([tenantId, createdAt])
  @@index([itemId, createdAt])
  @@map("inventory_transactions")
}

model InventoryRequisition {
  id              String   @id @default(uuid())
  tenantId        String
  branchId        String?
  requisitionNo   String?
  requestedBy     String
  departmentId    String?
  status          String   @default("PENDING") // PENDING, APPROVED, PARTIALLY_FULFILLED, FULFILLED, REJECTED
  priority        String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  requestDate     DateTime @default(now())
  approvedBy      String?
  approvedAt      DateTime?
  fulfilledBy     String?
  fulfilledAt     DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           RequisitionItem[]

  @@unique([tenantId, requisitionNo])
  @@index([tenantId, status])
  @@map("inventory_requisitions")
}

model RequisitionItem {
  id              String   @id @default(uuid())
  requisitionId   String
  itemName        String
  itemCode        String?
  quantityRequested Int
  quantityApproved  Int?
  quantityIssued    Int?
  unit            String?
  notes           String?

  requisition     InventoryRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)

  @@index([requisitionId])
  @@map("requisition_items")
}

// ==================== EQUIPMENT / ASSET MANAGEMENT ====================

enum AssetStatus {
  OPERATIONAL
  UNDER_MAINTENANCE
  OUT_OF_SERVICE
  DECOMMISSIONED
  IN_STORAGE
}

model Equipment {
  id                String      @id @default(uuid())
  tenantId          String
  branchId          String?
  name              String
  assetTag          String?
  serialNumber      String?
  manufacturer      String?
  model             String?
  category          String?     // MEDICAL, IT, FURNITURE, VEHICLE, etc.
  department        String?
  location          String?
  status            AssetStatus @default(OPERATIONAL)
  purchaseDate      DateTime?
  purchasePrice     Float?
  warrantyExpiry    DateTime?
  expectedLifeYears Int?
  depreciationRate  Float?
  currentValue      Float?
  supplier          String?
  notes             String?
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  maintenanceLogs   MaintenanceLog[]

  @@unique([tenantId, assetTag])
  @@index([tenantId, status])
  @@index([tenantId, category])
  @@map("equipment")
}

model MaintenanceLog {
  id              String   @id @default(uuid())
  equipmentId     String
  tenantId        String
  type            String   // PREVENTIVE, CORRECTIVE, CALIBRATION, INSPECTION
  description     String
  scheduledDate   DateTime?
  completedDate   DateTime?
  performedBy     String?
  vendor          String?
  cost            Float?
  partsUsed       String?
  status          String   @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  nextDueDate     DateTime?
  findings        String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  equipment       Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId, scheduledDate])
  @@index([tenantId, status])
  @@map("maintenance_logs")
}

// ==================== HR & PAYROLL ====================

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  LOCUM
  INTERN
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model StaffProfile {
  id                String         @id @default(uuid())
  tenantId          String
  userId            String         @unique
  employeeId        String?
  department        String?
  designation       String?
  employmentType    EmploymentType @default(FULL_TIME)
  dateOfJoining     DateTime?
  dateOfLeaving     DateTime?
  reportingTo       String?
  qualifications    String?
  specializations   String?
  licenseNumber     String?
  licenseExpiry     DateTime?
  bankName          String?
  bankAccountNumber String?
  bankBranch        String?
  ssnit             String?        // Ghana SSNIT number
  tinNumber         String?        // Tax Identification Number
  baseSalary        Float?
  allowances        Float?         @default(0)
  deductions        Float?         @default(0)
  isActive          Boolean        @default(true)
  notes             String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  leaveRequests     LeaveRequest[]
  payrollRecords    PayrollRecord[]

  @@unique([tenantId, employeeId])
  @@index([tenantId, department])
  @@map("staff_profiles")
}

model LeaveRequest {
  id              String      @id @default(uuid())
  staffProfileId  String
  tenantId        String
  leaveType       String      // ANNUAL, SICK, MATERNITY, PATERNITY, COMPASSIONATE, STUDY, UNPAID
  startDate       DateTime
  endDate         DateTime
  totalDays       Int
  reason          String?
  status          LeaveStatus @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  staffProfile    StaffProfile @relation(fields: [staffProfileId], references: [id])

  @@index([tenantId, status])
  @@index([staffProfileId, startDate])
  @@map("leave_requests")
}

model PayrollRecord {
  id              String   @id @default(uuid())
  staffProfileId  String
  tenantId        String
  period          String   // e.g. "2025-01"
  baseSalary      Float
  allowances      Float    @default(0)
  overtime        Float    @default(0)
  bonuses         Float    @default(0)
  grossPay        Float
  taxDeduction    Float    @default(0)
  ssnitDeduction  Float    @default(0)
  otherDeductions Float    @default(0)
  netPay          Float
  status          String   @default("DRAFT") // DRAFT, APPROVED, PAID
  paidAt          DateTime?
  approvedBy      String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  staffProfile    StaffProfile @relation(fields: [staffProfileId], references: [id])

  @@unique([staffProfileId, period])
  @@index([tenantId, period])
  @@index([tenantId, status])
  @@map("payroll_records")
}

model Attendance {
  id          String    @id @default(uuid())
  tenantId    String
  userId      String
  date        DateTime
  clockIn     DateTime?
  clockOut    DateTime?
  hoursWorked Float?
  status      String    @default("PRESENT") // PRESENT, ABSENT, LATE, HALF_DAY, ON_LEAVE
  notes       String?
  createdAt   DateTime  @default(now())

  @@unique([userId, date])
  @@index([tenantId, date])
  @@map("attendance")
}

// ==================== DRUG INTERACTION DATABASE ====================

model DrugInteraction {
  id            String   @id @default(uuid())
  drugAName     String   // Generic name keyword for drug A
  drugBName     String   // Generic name keyword for drug B
  severity      String   // CRITICAL, WARNING, INFO
  description   String   // Clinical description of the interaction
  mechanism     String?  // Pharmacological mechanism
  management    String?  // How to manage the interaction
  evidenceLevel String?  // HIGH, MODERATE, LOW
  source        String?  // Reference source (e.g., BNF, WHO)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([drugAName])
  @@index([drugBName])
  @@map("drug_interactions")
}

model CDSAlertLog {
  id              String   @id @default(uuid())
  tenantId        String
  patientId       String
  encounterId     String?
  prescriptionId  String?
  alertType       String   // ALLERGY, INTERACTION, PEDIATRIC_DOSE, DUPLICATE, RENAL, PREGNANCY
  severity        String   // CRITICAL, WARNING, INFO
  drugId          String?
  drugName        String?
  interactingDrug String?
  message         String
  details         String?
  wasOverridden   Boolean  @default(false)
  overriddenBy    String?
  overrideReason  String?
  overriddenAt    DateTime?
  context         String?  // PRESCRIBING, DISPENSING
  createdAt       DateTime @default(now())

  patient      Patient  @relation(fields: [patientId], references: [id])
  overrideUser User?    @relation("CDSOverrides", fields: [overriddenBy], references: [id])

  @@index([tenantId, patientId])
  @@index([tenantId, createdAt])
  @@index([alertType, severity])
  @@map("cds_alert_logs")
}

// ==================== GENERAL LEDGER ====================

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

model ChartOfAccount {
  id            String      @id @default(uuid())
  tenantId      String
  accountCode   String
  accountName   String
  accountType   AccountType
  parentId      String?
  description   String?
  isActive      Boolean     @default(true)
  normalBalance String      @default("DEBIT") // DEBIT or CREDIT
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  parent   ChartOfAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children ChartOfAccount[] @relation("AccountHierarchy")
  journalLines JournalLine[]

  @@unique([tenantId, accountCode])
  @@index([tenantId, accountType])
  @@map("chart_of_accounts")
}

model JournalEntry {
  id            String   @id @default(uuid())
  tenantId      String
  entryNumber   String
  entryDate     DateTime @default(now())
  description   String
  reference     String?
  sourceModule  String?  // BILLING, PHARMACY, PAYROLL, MANUAL
  sourceId      String?
  status        String   @default("POSTED") // DRAFT, POSTED, REVERSED
  reversedById  String?
  postedBy      String
  approvedBy    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lines JournalLine[]

  @@unique([tenantId, entryNumber])
  @@index([tenantId, entryDate])
  @@index([tenantId, status])
  @@map("journal_entries")
}

model JournalLine {
  id             String  @id @default(uuid())
  journalEntryId String
  accountId      String
  debit          Float   @default(0)
  credit         Float   @default(0)
  description    String?

  journalEntry JournalEntry   @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      ChartOfAccount @relation(fields: [accountId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
  @@map("journal_lines")
}

model FiscalPeriod {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  startDate DateTime
  endDate   DateTime
  status    String   @default("OPEN") // OPEN, CLOSED, LOCKED
  closedBy  String?
  closedAt  DateTime?
  createdAt DateTime @default(now())

  @@unique([tenantId, name])
  @@index([tenantId, status])
  @@map("fiscal_periods")
}
